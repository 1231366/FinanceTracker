<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WealthAI | Intelligence Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100;300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        :root { --accent: #6366f1; }
        body { font-family: 'Geist', sans-serif; background: #000; color: #fff; margin: 0; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        .glass { background: rgba(15, 15, 15, 0.75); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .dropdown-glass { background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(50px); border: 1px solid rgba(255, 255, 255, 0.15); z-index: 999; }
        .neo-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%); }
        .text-gradient { background: linear-gradient(to bottom, #fff 20%, #71717a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-title { font-size: clamp(2.5rem, 10vw, 5rem); line-height: 1; letter-spacing: -0.05em; font-weight: 900; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; }
        @media (max-width: 1024px) { .dashboard-grid { display: flex; flex-direction: column; } }
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const AssetIcon = ({ src, symbol }) => {
            const [error, setError] = useState(false);
            const initials = symbol ? symbol.split('.')[0].substring(0, 2).toUpperCase() : "??";
            if (error || !src) return (
                <div className="w-full h-full neo-gradient flex items-center justify-center text-[10px] font-black italic text-white rounded-xl uppercase">{initials}</div>
            );
            return <img src={src} className="w-full h-full object-contain opacity-90" onError={() => setError(true)} />;
        };

        const App = () => {
            const [assets, setAssets] = useState([]);
            const [marketPrices, setMarketPrices] = useState({});
            const [isModalOpen, setModalOpen] = useState(false);
            const [selectedAsset, setSelectedAsset] = useState(null);
            const [searchResults, setSearchResults] = useState([]);
            const [formData, setFormData] = useState({ symbol: '', name: '', quantity: '', price: '', type: 'crypto', thumb: '' });

            const cryptoMap = { 
                'BTC': 'bitcoin', 'ETH': 'ethereum', 'SOL': 'solana', 
                'ADA': 'cardano', 'BNB': 'binancecoin', 'XRP': 'ripple' 
            };

            const fetchData = async () => {
                try {
                    const res = await fetch('api/assets.php');
                    const data = await res.json();
                    const cleanData = Array.isArray(data) ? data : [];
                    setAssets(cleanData);
                    syncPrices(cleanData);
                } catch (e) { console.error("Assets Load Error", e); }
            };

            const syncPrices = async (portfolio) => {
                const updatedPrices = { ...marketPrices };

                // CRYPTO SYNC
                const cryptos = portfolio.filter(a => a.asset_type === 'crypto');
                if(cryptos.length > 0) {
                    const ids = cryptos.map(a => cryptoMap[a.symbol.toUpperCase()] || a.symbol.toLowerCase()).join(',');
                    try {
                        const res = await fetch(`api/prices.php?symbols=${ids}&type=crypto`);
                        const data = await res.json();
                        cryptos.forEach(a => {
                            const sym = a.symbol.toUpperCase();
                            const id = cryptoMap[sym] || a.symbol.toLowerCase();
                            if(data[id]) updatedPrices[sym] = data[id].eur;
                        });
                    } catch(e) { console.error("Crypto Price Error", e); }
                }

                // STOCK SYNC
                const stocks = portfolio.filter(a => a.asset_type === 'stock');
                if(stocks.length > 0) {
                    const symbols = stocks.map(a => a.symbol.split('.')[0].toUpperCase()).join(',');
                    try {
                        const res = await fetch(`api/prices.php?symbols=${symbols}&type=stock`);
                        const data = await res.json();
                        stocks.forEach(a => {
                            const sym = a.symbol.split('.')[0].toUpperCase();
                            // Procurar no objeto retornado (pode vir como sym: {eur: val})
                            if(data[sym] && data[sym].eur) updatedPrices[a.symbol.toUpperCase()] = data[sym].eur;
                        });
                    } catch(e) { console.error("Stock Price Error", e); }
                }

                setMarketPrices(updatedPrices);
            };

            const handleSearch = async (query) => {
                if (query.length < 2) { setSearchResults([]); return; }
                try {
                    const res = await fetch(`api/search.php?q=${query}`);
                    const data = await res.json();
                    setSearchResults(Array.isArray(data) ? data : []);
                } catch (e) { setSearchResults([]); }
            };

            const handleAddAsset = async (e) => {
                e.preventDefault();
                try {
                    const res = await fetch('api/assets.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    const result = await res.json();
                    if(result.status === 'success') {
                        setModalOpen(false);
                        setFormData({ symbol: '', name: '', quantity: '', price: '', type: 'crypto', thumb: '' });
                        fetchData();
                    }
                } catch (e) { console.error("Add Asset Error", e); }
            };

            useEffect(() => { fetchData(); }, []);

            const stats = useMemo(() => {
                let invested = 0, current = 0;
                assets.forEach(a => {
                    const sym = a.symbol.toUpperCase();
                    const qty = parseFloat(a.quantity) || 0;
                    const buy = parseFloat(a.buy_price) || 0;
                    const now = marketPrices[sym] || buy;
                    invested += qty * buy;
                    current += qty * now;
                });
                const profit = current - invested;
                const pct = invested > 0 ? (profit / invested) * 100 : 0;
                return { current, profit, pct };
            }, [assets, marketPrices]);

            const renderMainChart = () => {
                const series = assets.map(a => {
                    const now = marketPrices[a.symbol.toUpperCase()] || parseFloat(a.buy_price);
                    return parseFloat(a.quantity) * now;
                });
                if(!series.length || series.every(v => v === 0)) return;
                const options = {
                    series: series,
                    chart: { type: 'donut', height: 320, background: 'transparent' },
                    labels: assets.map(a => a.symbol.toUpperCase()),
                    colors: ['#6366f1', '#a855f7', '#ec4899', '#3b82f6', '#10b981'],
                    legend: { show: false },
                    stroke: { show: false },
                    plotOptions: { pie: { donut: { size: '75%', background: 'transparent' } } },
                    dataLabels: { enabled: false }
                };
                const el = document.querySelector("#mainChart");
                if(el) { el.innerHTML = ""; new ApexCharts(el, options).render(); }
            };

            useEffect(() => { if (assets.length) renderMainChart(); }, [assets, marketPrices]);

            return (
                <div className="min-h-screen pb-40">
                    <header className="safe-top px-10 py-10 flex justify-between items-center sticky top-0 z-40 bg-black/60 backdrop-blur-xl border-b border-white/5">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 neo-gradient rounded-xl rotate-12 flex items-center justify-center shadow-lg"><span className="font-black italic">W</span></div>
                            <h1 className="text-xl font-black italic tracking-tighter uppercase leading-none">WealthAI</h1>
                        </div>
                        <div className="px-4 py-2 glass rounded-full text-[10px] font-bold text-zinc-500 uppercase tracking-widest italic">Stable Feed</div>
                    </header>

                    <main className="px-6 md:px-10 max-w-7xl mx-auto mt-12">
                        <section className="mb-16 text-center animate-float">
                            <p className="text-zinc-500 text-[10px] font-black uppercase tracking-[0.4em] mb-4 opacity-60 italic text-center">Consolidated Valuation</p>
                            <h2 className="hero-title text-gradient italic mb-6 uppercase text-center">
                                €{stats.current.toLocaleString('pt-PT', { minimumFractionDigits: 2 })}
                            </h2>
                            <div className={`inline-block px-6 py-2 rounded-full glass border ${stats.profit >= 0 ? 'border-emerald-500/20 text-emerald-400' : 'border-rose-500/20 text-rose-400'} font-bold text-sm italic`}>
                                {stats.profit >= 0 ? '▲' : '▼'} €{Math.abs(stats.profit).toLocaleString('pt-PT', { minimumFractionDigits: 2 })} ({stats.pct.toFixed(2)}%)
                            </div>
                        </section>

                        <div className="dashboard-grid">
                            <div className="col-span-12 lg:col-span-7 glass rounded-[48px] p-10 flex flex-col items-center justify-center min-h-[400px]">
                                <h3 className="text-[11px] font-bold italic uppercase tracking-widest mb-6 opacity-40 self-start">Wealth Allocation</h3>
                                <div id="mainChart" className="w-full"></div>
                            </div>

                            <div className="col-span-12 lg:col-span-5 glass rounded-[48px] overflow-hidden flex flex-col border-white/5">
                                <div className="p-8 border-b border-white/5 flex justify-between items-center bg-white/[0.01]">
                                    <h3 className="text-[11px] font-bold italic uppercase tracking-widest">Holdings</h3>
                                    <button onClick={() => setModalOpen(true)} className="w-10 h-10 rounded-2xl neo-gradient text-white font-bold flex items-center justify-center shadow-xl hover:scale-110 active:scale-95 transition-all">+</button>
                                </div>
                                <div className="divide-y divide-white/5 overflow-y-auto max-h-[500px] custom-scrollbar">
                                    {assets.map((a, i) => {
                                        const sym = a.symbol.toUpperCase();
                                        const now = marketPrices[sym] || parseFloat(a.buy_price);
                                        const pnl = ((now - parseFloat(a.buy_price)) / parseFloat(a.buy_price)) * 100;
                                        return (
                                            <div key={i} onClick={() => setSelectedAsset(a)} className="p-7 flex justify-between items-center hover:bg-white/[0.04] transition-all group cursor-pointer text-left">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 glass rounded-2xl flex items-center justify-center p-2.5 overflow-hidden group-hover:border-indigo-500/50">
                                                        <AssetIcon src={a.image_url} symbol={a.symbol} />
                                                    </div>
                                                    <div>
                                                        <p className="font-black text-base leading-none mb-1 uppercase">{a.symbol}</p>
                                                        <p className={`text-[9px] font-bold uppercase ${pnl >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                                            {pnl >= 0 ? '▲' : '▼'} {Math.abs(pnl).toFixed(2)}%
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-black text-base italic leading-none mb-1">€{(parseFloat(a.quantity) * now).toLocaleString('pt-PT', { minimumFractionDigits: 2 })}</p>
                                                    <p className="text-[10px] text-zinc-500 font-bold italic">Avg €{parseFloat(a.buy_price).toLocaleString('pt-PT', { minimumFractionDigits: 2 })}</p>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </main>

                    <nav className="fixed bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-sm glass rounded-[35px] h-24 flex justify-around items-center px-4 z-[100] border-white/10 shadow-2xl">
                        <div onClick={() => setSelectedAsset(null)} className="text-indigo-400 font-black text-[9px] uppercase tracking-widest cursor-pointer group flex flex-col items-center gap-1"><span className="w-1 h-1 bg-indigo-400 rounded-full"></span>Dash</div>
                        <div onClick={() => setModalOpen(true)} className="w-16 h-16 neo-gradient rounded-full flex items-center justify-center text-3xl font-light -translate-y-12 shadow-2xl border-[8px] border-[#000] active:scale-90 transition-all cursor-pointer text-white">+</div>
                        <div className="text-zinc-600 font-black text-[9px] uppercase tracking-widest italic cursor-not-allowed">Profile</div>
                    </nav>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-8 bg-black/95 backdrop-blur-md">
                            <form onSubmit={handleAddAsset} className="glass w-full max-w-lg rounded-[48px] p-10 md:p-12 relative shadow-3xl">
                                <button type="button" onClick={() => setModalOpen(false)} className="absolute top-10 right-10 text-zinc-500 font-black text-xs italic uppercase">Close [X]</button>
                                <h2 className="text-3xl font-black italic tracking-tighter mb-10 text-gradient uppercase text-center leading-none">New Acquisition</h2>
                                <div className="space-y-8">
                                    <div className="relative">
                                        <label className="text-[10px] font-black text-zinc-500 uppercase tracking-widest mb-3 block italic text-left">Search Network</label>
                                        <input autoFocus onChange={(e) => handleSearch(e.target.value)} className="w-full bg-white/[0.03] border border-white/10 rounded-3xl px-8 py-6 focus:border-indigo-500 outline-none transition-all font-bold text-lg" placeholder="eg: Apple, Bitcoin..." />
                                        {searchResults.length > 0 && (
                                            <div className="absolute top-full left-0 w-full dropdown-glass mt-4 rounded-[32px] overflow-hidden shadow-2xl max-h-64 overflow-y-auto custom-scrollbar">
                                                {searchResults.map((s, i) => (
                                                    <div key={i} onClick={() => { setFormData({...formData, symbol: s.symbol, name: s.name, thumb: s.thumb, type: s.type}); setSearchResults([]); }} className="p-6 flex items-center gap-5 hover:bg-indigo-500/20 cursor-pointer border-b border-white/5 transition-all text-left">
                                                        <div className="w-10 h-10 glass rounded-xl flex items-center justify-center overflow-hidden p-1.5 bg-black/40"><AssetIcon src={s.thumb} symbol={s.symbol} /></div>
                                                        <div className="flex-1 text-left"><p className="font-black text-sm italic tracking-tight">{s.name}</p><p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">{s.symbol} • {s.type}</p></div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <input required type="number" step="any" placeholder="Qty" value={formData.quantity} onChange={(e) => setFormData({...formData, quantity: e.target.value})} className="w-full bg-white/[0.03] border border-white/10 rounded-3xl p-6 outline-none focus:border-indigo-500 font-bold" />
                                        <input required type="number" step="any" placeholder="Buy Price €" value={formData.price} onChange={(e) => setFormData({...formData, price: e.target.value})} className="w-full bg-white/[0.03] border border-white/10 rounded-3xl p-6 outline-none focus:border-indigo-500 font-bold" />
                                    </div>
                                    <button type="submit" className="w-full h-20 neo-gradient rounded-[32px] font-black uppercase text-xs tracking-[0.4em] shadow-xl text-white">Execute Trade</button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>